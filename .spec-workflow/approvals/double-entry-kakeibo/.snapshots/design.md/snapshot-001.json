{
  "id": "snapshot_1765724740348_t7gktsm7r",
  "approvalId": "approval_1765724740341_oc0jfa1l0",
  "approvalTitle": "Design approval: double-entry household bookkeeping (kakeibo)",
  "version": 1,
  "timestamp": "2025-12-14T15:05:40.348Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本機能は、家計簿データを複式簿記の基本構造（勘定科目・仕訳・元帳）で保持し、家計用途の「簡易入力（支出/収入/振替）」を仕訳へ変換して永続化する。集計は仕訳（借方/貸方明細）を唯一の正とし、残高・収支・推移レポートを導出する。\n\n前提: 現時点のリポジトリには実装がほぼ存在しないため、本設計は「ローカルファーストで拡張可能な最小構成」を提示する。\n\n## Steering Document Alignment\n\n`.spec-workflow/steering/` が未整備のため、以下は暫定の設計原則とする（steering 作成後に整合を再確認する）。\n\n### Technical Standards (tech.md)\n- ドメインモデル（複式簿記の整合）を中心に設計し、UI/永続化から独立させる\n- 金額は浮動小数を避け、通貨最小単位（JPY=1円）で整数として扱う\n- 仕訳の不変条件（借貸一致）を保存時に必ず検証する\n\n### Project Structure (structure.md)\n- `domain/`（モデル/不変条件）、`services/`（ユースケース）、`storage/`（永続化I/Fと実装）、`ui/`（CLI/GUI 等）の分離を推奨\n\n## Code Reuse Analysis\n\n既存コードがほぼ無いため、再利用対象は現状なし。今後の実装では、計算ロジック（残高算定/レポート）を純粋関数として切り出し、UIから再利用できる形にする。\n\n## Architecture\n\n### High-level\n- **Domain**: `Book` / `Account` / `JournalEntry` / `Posting` / `ImportedTransaction`\n- **Services (use-cases)**: 仕訳作成、簡易入力→仕訳生成、インポート、レポート生成、エクスポート/バックアップ\n- **Storage**: 永続化I/F（例: `LedgerRepository`）と実装（例: SQLite/ファイル）\n- **UI**: 入力/一覧/レポート表示（後続タスクで具体化）\n\n```mermaid\ngraph TD\n  UI[UI: CLI/GUI] --> UC[Use-cases / Services]\n  UC --> DM[Domain Models + Validation]\n  UC --> Repo[LedgerRepository Interface]\n  Repo --> DB[(SQLite or file)]\n```\n\n### Modular Design Principles\n- 仕訳バリデーションとレポート計算をドメイン/サービスに閉じ込める（UI・DBから独立）\n- 永続化はリポジトリI/Fで抽象化し、SQLite→別ストレージへ置換可能にする\n\n## Components and Interfaces\n\n### LedgerRepository（永続化I/F）\n- **Purpose:** 帳簿、科目、仕訳、インポート明細のCRUDと検索を提供する\n- **Interfaces (examples):**\n  - `createBook(name) -> bookId`\n  - `listBooks()`\n  - `upsertAccount(bookId, account)`\n  - `listAccounts(bookId, { includeInactive })`\n  - `createJournalEntry(bookId, entry)`\n  - `updateJournalEntry(bookId, entryId, patch)`（編集ポリシーは後述）\n  - `listJournalEntries(bookId, { from, to, accountId?, textQuery? })`\n  - `createImportedTransactions(bookId, source, rows)`\n  - `listImportedTransactions(bookId, { status })`\n  - `linkImportedTransaction(bookId, importedId, entryId)`\n\n### JournalEntryService（仕訳ユースケース）\n- **Purpose:** 仕訳の作成/編集、整合性検証、簡易入力からの生成を担う\n- **Dependencies:** `LedgerRepository`, `Clock`（日付既定値）, `IdGenerator`\n- **Interfaces (examples):**\n  - `createEntry(bookId, draft) -> entryId`\n  - `createExpense(bookId, { date, payFromAccountId, expenseAccountId, amount, memo, splits? })`\n  - `createIncome(bookId, { date, depositToAccountId, revenueAccountId, amount, memo })`\n  - `createTransfer(bookId, { date, fromAccountId, toAccountId, amount, memo })`\n  - `createCardPayment(bookId, { date, bankAccountId, cardLiabilityAccountId, amount, memo })`\n\n### ReportingService（レポート）\n- **Purpose:** 残高・収支・推移・元帳を仕訳から導出する\n- **Interfaces (examples):**\n  - `getTrialBalance(bookId, asOfDate)`\n  - `getBalanceSheet(bookId, asOfDate)`\n  - `getIncomeStatement(bookId, { from, to })`\n  - `getLedger(bookId, accountId, { from, to })`\n\n### ImportService（明細取り込み）\n- **Purpose:** CSV取り込み、重複検知、未確定取引→仕訳化（確定）を担う\n- **Interfaces (examples):**\n  - `importCsv(bookId, { source, csv, mapping }) -> importedCount`\n  - `confirmImported(bookId, importedId, { mappingToEntryDraft }) -> entryId`\n  - `ignoreImported(bookId, importedId)`\n\n## Data Models\n\n### Book\n- `id: string`\n- `name: string`\n- `createdAt: ISODateTime`\n\n### Account\n- `id: string`\n- `bookId: string`\n- `name: string`\n- `type: \"asset\" | \"liability\" | \"equity\" | \"revenue\" | \"expense\"`\n- `isActive: boolean`\n- `createdAt: ISODateTime`\n\n補助属性（任意）:\n- `externalKey?: string`（インポート連携用の識別子）\n\n### JournalEntry\n- `id: string`\n- `bookId: string`\n- `date: ISODate`（会計日付）\n- `memo?: string`\n- `postings: Posting[]`\n- `createdAt: ISODateTime`\n- `updatedAt: ISODateTime`\n\n### Posting\n- `id: string`\n- `entryId: string`\n- `accountId: string`\n- `side: \"debit\" | \"credit\"`\n- `amount: number`（JPY前提: 1円単位の整数、常に正の値）\n- `description?: string`（分割明細の摘要など）\n\n### ImportedTransaction\n- `id: string`\n- `bookId: string`\n- `source: string`（例: \"bank-xxx\", \"card-yyy\"）\n- `date: ISODate`\n- `amount: number`（正負はソース基準で保持してもよいが、確定時に仕訳へ正規化する）\n- `payeeOrMemo?: string`\n- `raw: object`（元データ）\n- `dedupKey: string`（外部ID or ハッシュ）\n- `status: \"pending\" | \"linked\" | \"ignored\"`\n- `linkedEntryId?: string`\n\n## Key Rules / Invariants\n\n- **借貸一致**: `sum(debit.amount) == sum(credit.amount)` を満たす仕訳のみ保存可能\n- **金額の型**: 金額は整数（JPY=円）。UI層で小数入力があれば整数へ正規化してから保存\n- **削除ポリシー**: 監査性のため、仕訳は物理削除せず「取消仕訳」や「編集履歴」を推奨（初期は update を許可し、後から厳格化できる設計にする）\n- **科目削除**: 使用済み科目は削除不可、`isActive=false` による無効化\n\n## Error Handling\n\n### Error Scenarios\n1. **借貸不一致**\n   - **Handling:** サービス層で検証し保存を拒否、差額と不足側（借方/貸方）を返す\n   - **User Impact:** 入力フォームで差額表示し、修正箇所へ誘導\n\n2. **参照不整合（存在しないaccountId/bookId）**\n   - **Handling:** リポジトリ層のFK制約（SQLiteの場合）+ サービス層で事前検証\n   - **User Impact:** 「選択された口座/科目が見つからない」エラー\n\n3. **インポート重複**\n   - **Handling:** `dedupKey` の一意制約で検知。スキップ/上書き（更新）を選択可能にする\n   - **User Impact:** 重複候補の件数と選択肢を提示\n\n## Storage Choice (Recommended)\n\n初期実装は以下のいずれかを推奨（後続タスクで選定・確定）。\n- **SQLite（推奨）**: 参照整合・クエリ・集計が容易。バックアップはDBファイルコピーで実現可能\n- **ファイル（JSON/CSV）**: 最小構成だが集計・検索が重くなりやすい\n\n## Testing Strategy\n\n### Unit Testing\n- 仕訳バリデーション（借貸一致、分割、カード返済等の簡易入力→仕訳生成）\n- 残高計算（資産/負債/純資産、収支レポートの期間集計）\n- インポート重複検知（`dedupKey` 生成と一意性）\n\n### Integration Testing\n- リポジトリ実装（SQLiteなら in-memory/テンポラリDB）でCRUDと制約確認\n- 代表的ユースケース（支出→残高変化、カード利用→負債増、返済→負債減）\n\n### End-to-End Testing\n- 最小フロー: 科目作成 → 支出入力 → レポート確認 → エクスポート/復元（UIができ次第）\n",
  "fileStats": {
    "size": 7864,
    "lines": 174,
    "lastModified": "2025-12-14T15:05:33.342Z"
  },
  "comments": []
}